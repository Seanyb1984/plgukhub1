generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- CORE CLINIC STRUCTURE ---

model Site {
  id                String            @id @default(cuid())
  name              String
  brand             Brand
  address           String?
  phone             String?
  email             String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  clients           Client[]
  enquiries         Enquiry[]
  submissions       FormSubmission[]
  users             User[]
  treatmentEpisodes TreatmentEpisode[] 

  @@unique([name, brand])
  @@index([brand])
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  name              String
  passwordHash      String
  role              Role
  brand             Brand
  siteId            String
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLoginAt       DateTime?
  amendments        Amendment[]
  auditLogs         AuditLog[]
  submissions       FormSubmission[]
  treatmentEpisodes TreatmentEpisode[] 
  site              Site              @relation(fields: [siteId], references: [id])

  @@index([brand, siteId])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  @@index([userId])
}

// --- CLIENT & CLINICAL DATA ---

model Client {
  id                String            @id @default(cuid())
  clientId          String            @unique @default(cuid()) 
  brand             Brand
  siteId            String
  firstName         String
  lastName          String
  email             String?
  phone             String?
  dateOfBirth       DateTime?
  gender            String?
  addressLine1      String?
  addressLine2      String?
  city              String?
  postcode          String?
  country           String?           @default("United Kingdom")
  emergencyName     String?
  emergencyPhone    String?
  emergencyRelation String?
  marketingEmail    Boolean           @default(false)
  marketingSms      Boolean           @default(false)
  marketingPhone    Boolean           @default(false)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  site              Site              @relation(fields: [siteId], references: [id])
  submissions       FormSubmission[]
  treatmentEpisodes TreatmentEpisode[] 

  @@index([brand, siteId])
  @@index([email])
  @@index([phone])
  @@index([lastName, firstName])
}

// MASTER TREATMENT EPISODE
model TreatmentEpisode {
  id                  String            @id @default(cuid()) // Unified to cuid()
  clientId            String
  siteId              String
  practitionerId      String
  brand               Brand             @default(PLG_UK)
  
  status              EpisodeStatus     @default(CONSULTATION)
  treatmentType       String           
  riskScore           Int               @default(0)
  
  medicalSnapshot     Json             
  consentVersion      String            @default("1.0")
  
  batchNumber         String?          
  productUsed         String?
  volumeUsed          String?
  procedureNotes      String?           @db.Text
  
  signatureData       String?           @db.Text
  ipAddress           String?
  userAgent           String?
  signedAt            DateTime?
  
  aftercareSent       Boolean           @default(false)
  followUpScheduled   Boolean           @default(false)
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  client              Client            @relation(fields: [clientId], references: [id])
  site                Site              @relation(fields: [siteId], references: [id])
  practitioner        User              @relation(fields: [practitionerId], references: [id])

  @@index([clientId])
  @@index([batchNumber])
  @@index([status])
}

model BatchRegister {
  id             String   @id @default(cuid())
  batchNumber    String   @unique
  productName    String
  expiryDate     DateTime
  supplier       String?
  receivedAt     DateTime @default(now())
  totalUnits     Float?
  unitsRemaining Float?
  
  @@index([batchNumber])
}

// --- FORMS & AUDIT ---

model FormSubmission {
  id                  String           @id @default(cuid())
  formType            String
  formVersion         String           @default("1.0")
  brand               Brand
  siteId              String
  clientId            String?
  appointmentId       String?
  data                Json
  status              SubmissionStatus @default(DRAFT)
  riskLevel           RiskLevel        @default(NONE)
  riskFlags           String[]
  requiresEscalation  Boolean          @default(false)
  escalationReason    String?
  escalatedAt         DateTime?
  escalatedToId       String?
  signatureData       String?
  signedAt            DateTime?
  signedByName        String?
  signedByIp          String?
  practitionerId      String?
  draftSavedAt        DateTime?
  resumeToken         String?          @unique
  isLocked            Boolean          @default(false)
  lockedAt            DateTime?
  lockedReason        String?
  pdfPath             String?
  pdfGeneratedAt      DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  submittedAt         DateTime?
  amendments          Amendment[]
  auditLogs           AuditLog[]
  client              Client?          @relation(fields: [clientId], references: [id])
  practitioner        User?            @relation(fields: [practitionerId], references: [id])
  site                Site             @relation(fields: [siteId], references: [id])

  @@index([brand, siteId])
  @@index([formType])
  @@index([clientId])
  @@index([status])
}

model Amendment {
  id            String         @id @default(cuid())
  submissionId  String
  reason        String
  changedFields Json
  newData       Json
  signatureData String?
  signedAt      DateTime?
  signedByName  String?
  amendedById   String
  createdAt     DateTime       @default(now())
  amendedBy     User           @relation(fields: [amendedById], references: [id])
  submission    FormSubmission @relation(fields: [submissionId], references: [id])

  @@index([submissionId])
}

model AuditLog {
  id            String          @id @default(cuid())
  submissionId  String?
  action        String
  userId        String?
  previousData  Json?
  newData       Json?
  changedFields String[]
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime        @default(now())
  submission    FormSubmission? @relation(fields: [submissionId], references: [id])
  user          User?           @relation(fields: [userId], references: [id])

  @@index([submissionId])
  @@index([userId])
}

model Enquiry {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  message   String
  source    String
  status    String   @default("NEW")
  brand     Brand
  siteId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  site      Site     @relation(fields: [siteId], references: [id])

  @@index([brand])
  @@index([status])
}

// --- ENUMS ---

enum Brand {
  MENHANCEMENTS
  WAX_FOR_MEN
  WAX_FOR_WOMEN
  PLG_UK
}

enum Role {
  ADMIN
  PRACTITIONER
  RECEPTION
}

enum EpisodeStatus {
  CONSULTATION
  CONSENTED
  TREATED
  FOLLOW_UP
  CLOSED
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  SIGNED
  LOCKED
  AMENDED
}

enum RiskLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  CRITICAL
}