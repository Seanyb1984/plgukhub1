// PLG UK Hub - Multi-Brand Clinical Management System
// CQC-Compliant Medical Aesthetics + Waxing Platform
// Unified Client Database with Phased Treatment Journeys

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // âœ… FIXED: Added this required line
}

// ============================================
// ENUMS
// ============================================

enum Brand {
  MENHANCEMENTS
  WAX_FOR_MEN
  WAX_FOR_WOMEN
  PLG_UK
}

enum Role {
  ADMIN
  PRESCRIBER
  PRACTITIONER
  STAFF
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  SIGNED
  LOCKED
  AMENDED
}

enum RiskLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ClientStatus {
  PROSPECT   // Enquiry only, not yet treated
  ACTIVE     // Has had at least one treatment
  INACTIVE   // No treatments in 12+ months
  ARCHIVED   // Data retention expired
}

enum TreatmentPhase {
  IDENTIFICATION   // Phase 0
  POM_TRIAGE        // Phase 1
  LEGAL_CONSENT    // Phase 2
  CLINICAL_RECORD  // Phase 3
  CLOSE_OUT        // Phase 4
}

enum TreatmentJourneyStatus {
  IN_PROGRESS
  STOPPED          // Hard-stopped by safety screening
  COMPLETED
  CANCELLED
}

enum GovernanceFormType {
  FIRE_SAFETY_CHECK
  CLEANING_LOG
  STAFF_TRAINING_SIGNOFF
  EQUIPMENT_CHECK
  INCIDENT_REPORT
  WASTE_DISPOSAL_LOG
}

enum EpisodeStatus {
  OPEN               // Episode created, not yet started
  CONSENT_PENDING    // Awaiting pre-consent form
  CONSENT_SIGNED     // Client signed, awaiting treatment
  IN_TREATMENT       // Actively being treated
  TREATMENT_COMPLETE // Treatment done, awaiting close-out
  CLOSED             // Fully closed with aftercare sent
  CANCELLED          // Cancelled before completion
  HARD_STOPPED       // Blocked by CQC safety screening
}

// ============================================
// ORGANIZATIONS
// ============================================

model Site {
  id        String   @id @default(cuid())
  name      String
  brand     Brand
  address   String?
  phone     String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  submissions        FormSubmission[]
  clients            Client[]
  treatmentJourneys  TreatmentJourney[]
  treatmentEpisodes  TreatmentEpisode[]
  governanceLogs     GovernanceLog[]

  @@unique([name, brand])
  @@index([brand])
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  passwordHash  String
  role          Role
  brand         Brand
  siteId        String
  site          Site      @relation(fields: [siteId], references: [id])
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  submissions           FormSubmission[]
  auditLogs              AuditLog[]
  amendments             Amendment[]
  treatmentJourneys      TreatmentJourney[]  @relation("PractitionerJourneys")
  prescribedJourneys    TreatmentJourney[]  @relation("PrescriberJourneys")
  episodes              TreatmentEpisode[]  @relation("EpisodePractitioner")
  prescribedEpisodes    TreatmentEpisode[]  @relation("EpisodePrescriber")
  governanceLogs        GovernanceLog[]
  trainingSignoffs      StaffTraining[]

  @@index([brand, siteId])
  @@index([role])
}

// ============================================
// PRESCRIBERS
// ============================================

model Prescriber {
  id                    String   @id @default(cuid())
  userId                String?  @unique
  name                  String
  gmcNumber             String   @unique  // General Medical Council number
  prescriberType        String   @default("Doctor") // Doctor, Nurse Prescriber, Pharmacist
  specialisations        String[] // e.g., ["Aesthetics", "Dermatology"]
  isActive              Boolean  @default(true)
  licenceVerifiedAt      DateTime?
  licenceExpiresAt      DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  treatmentJourneys     TreatmentJourney[]
  treatmentEpisodes     TreatmentEpisode[]

  @@index([gmcNumber])
  @@index([isActive])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  @@index([userId])
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id              String       @id @default(cuid())
  clientId        String       @unique @default(cuid()) // External-facing ID
  status          ClientStatus @default(PROSPECT)
  isProspect      Boolean      @default(true)     // True until first treatment completed
  marketingConsent Boolean      @default(false)     // GDPR marketing opt-in

  // Brands this client has records with
  brands          Brand[]

  // Site of first registration
  siteId          String
  site            Site         @relation(fields: [siteId], references: [id])

  // Personal Information
  firstName       String
  lastName        String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  gender          String?

  // Address
  addressLine1    String?
  addressLine2    String?
  city            String?
  postcode        String?
  country         String?  @default("United Kingdom")

  // Emergency Contact
  emergencyName   String?
  emergencyPhone  String?
  emergencyRelation String?

  // Medical flags
  hasBloodDisorder    Boolean @default(false)
  isPregnant          Boolean @default(false)
  hasAllergies        Boolean @default(false)
  allergyDetails      String?
  currentMedications  String?
  medicalNotes        String?

  // Preferences
  marketingEmail  Boolean  @default(false)
  marketingSms    Boolean  @default(false)
  marketingPhone  Boolean  @default(false)

  // Google Drive
  googleDriveFolderId  String?  // Auto-created folder for this client

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  submissions        FormSubmission[]
  treatmentJourneys  TreatmentJourney[]
  treatmentEpisodes  TreatmentEpisode[]
  clinicalPhotos     ClinicalPhoto[]

  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([lastName, firstName])
  @@index([siteId])
}

// ============================================
// INQUIRIES
// ============================================

model Inquiry {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  brand       Brand
  message     String?

  // Conversion tracking
  isConverted Boolean  @default(false)
  convertedAt DateTime?
  convertedClientId String?  // Links to the Client created on conversion

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([brand])
  @@index([isConverted])
  @@index([email])
}

// ============================================
// TREATMENT EPISODES
// ============================================

model TreatmentEpisode {
  id                String         @id @default(cuid())
  episodeRef        String         @unique @default(cuid())  // Human-readable reference
  brand             Brand
  siteId            String
  site              Site           @relation(fields: [siteId], references: [id])
  status            EpisodeStatus  @default(OPEN)

  // Client
  clientId          String
  client            Client         @relation(fields: [clientId], references: [id])

  // Practitioner
  practitionerId    String
  practitioner      User           @relation("EpisodePractitioner", fields: [practitionerId], references: [id])

  // Prescriber
  isPom             Boolean        @default(false)
  prescriberId      String?
  prescriber        Prescriber?    @relation(fields: [prescriberId], references: [id])
  prescriberUserId  String?
  prescriberUser    User?          @relation("EpisodePrescriber", fields: [prescriberUserId], references: [id])
  gmcNumberAtTime   String?        // Snapshot
  faceToFaceDate    DateTime?      // Consultation date

  // Pre-Consent
  medicalHistory      Json?      
  safetyScreening      Json?      
  safetyScreeningPass Boolean?   
  hardStopReason      String?    
  dynamicRisks        Json?      
  consentDeclaration  String?    
  signatureData        String?    
  signedByName        String?    
  signedAt            DateTime?  
  beforePhotoIds      String[]   
  webcamCaptureData    String?    

  // Treatment Record
  treatmentType       String?    
  treatmentAreas      String[]   
  productUsed         String?    
  batchRegisterId      String?    
  batchRegister        BatchRegister? @relation(fields: [batchRegisterId], references: [id])
  batchNumber         String?    
  lotNumber           String?
  expiryDate          DateTime?
  dosage              String?
  injectionSites      Json?
  clinicalNotes       String?
  complications       String?

  // Post-Treatment
  afterPhotoIds       String[]   
  aftercareProvided    Boolean    @default(false)
  aftercareEmailSent  Boolean    @default(false)
  aftercareEmailSentAt DateTime?
  aftercareTemplateId String?    
  followUpDate        DateTime?
  followUpNotes       String?

  // Record Locking
  isLocked            Boolean    @default(false)
  lockedAt            DateTime?
  lockedById          String?
  lockReason          String?    

  // Metadata
  openedAt            DateTime   @default(now())
  completedAt          DateTime?
  cancelledAt          DateTime?
  cancelReason        String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([brand, siteId])
  @@index([clientId])
  @@index([practitionerId])
  @@index([status])
  @@index([createdAt])
  @@index([batchRegisterId])
}

// ============================================
// BATCH REGISTER
// ============================================

model BatchRegister {
  id              String   @id @default(cuid())
  brand            Brand
  siteId          String

  productName     String     
  manufacturer    String?    
  batchNumber     String     
  lotNumber       String?
  expiryDate      DateTime   
  supplier        String?    

  quantityReceived  Int      @default(0)  
  quantityUsed      Int      @default(0)  
  quantityRemaining Int      @default(0)  
  unitOfMeasure      String   @default("units") 

  receivedAt      DateTime   @default(now())
  receivedById    String?    
  isActive        Boolean    @default(true) 
  notes           String?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  episodes        TreatmentEpisode[]

  @@unique([batchNumber, productName, brand])
  @@index([brand, siteId])
  @@index([productName])
  @@index([expiryDate])
  @@index([isActive])
}

// ============================================
// TREATMENT JOURNEY (Legacy)
// ============================================

model TreatmentJourney {
  id                String                  @id @default(cuid())
  journeyNumber     String                  @unique @default(cuid()) 
  brand             Brand
  siteId            String
  site              Site                    @relation(fields: [siteId], references: [id])

  clientId          String
  client            Client                  @relation(fields: [clientId], references: [id])

  practitionerId    String
  practitioner      User                    @relation("PractitionerJourneys", fields: [practitionerId], references: [id])

  currentPhase      TreatmentPhase          @default(IDENTIFICATION)
  status            TreatmentJourneyStatus  @default(IN_PROGRESS)

  identificationCompletedAt  DateTime?

  isPomTreatment              Boolean     @default(false)
  prescriberId                String?
  prescriber                  Prescriber? @relation(fields: [prescriberId], references: [id])
  prescriberUserId            String?
  prescriberUser              User?       @relation("PrescriberJourneys", fields: [prescriberUserId], references: [id])
  gmcNumberVerified          String?     
  faceToFaceDate              DateTime?   
  pomTriageCompletedAt        DateTime?
  pomNotes                    String?

  safetyScreeningData        Json?       
  safetyScreeningPassed      Boolean?
  stopReason                  String?     
  consentDeclaration          String?
  signatureData              String?     
  signedByName                String?
  signedAt                    DateTime?
  consentCompletedAt          DateTime?

  treatmentType               String?     
  treatmentArea              String[]    
  productUsed                 String?
  batchNumber                String?     
  lotNumber                  String?
  expiryDate                  DateTime?
  dosage                      String?     
  injectionSites              Json?       
  clinicalNotes              String?
  complications              String?
  clinicalRecordCompletedAt  DateTime?

  aftercareProvided          Boolean     @default(false)
  aftercareEmailSent          Boolean     @default(false)
  aftercareEmailSentAt        DateTime?
  followUpDate                DateTime?
  followUpNotes               String?
  closeOutCompletedAt        DateTime?

  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  clinicalPhotos  ClinicalPhoto[]
  auditLogs        AuditLog[]

  @@index([brand, siteId])
  @@index([clientId])
  @@index([practitionerId])
  @@index([status])
  @@index([currentPhase])
  @@index([createdAt])
}

// ============================================
// CLINICAL PHOTOS
// ============================================

model ClinicalPhoto {
  id                  String   @id @default(cuid())
  treatmentJourneyId  String
  treatmentJourney    TreatmentJourney @relation(fields: [treatmentJourneyId], references: [id])
  clientId            String
  client              Client   @relation(fields: [clientId], references: [id])

  photoType            String   // "before" | "after"
  phase                TreatmentPhase
  imageData            String   
  mimeType             String   @default("image/jpeg")
  fileName             String?

  facialMappingData    Json?    

  googleDriveFileId    String?
  googleDriveSynced    Boolean  @default(false)

  capturedAt          DateTime @default(now())
  capturedById        String?

  @@index([treatmentJourneyId])
  @@index([clientId])
  @@index([photoType])
}

// ============================================
// FORM SUBMISSIONS
// ============================================

model FormSubmission {
  id              String           @id @default(cuid())
  formType        String
  formVersion     String           @default("1.0")
  brand            Brand
  siteId          String
  site            Site             @relation(fields: [siteId], references: [id])

  clientId        String?
  client          Client?          @relation(fields: [clientId], references: [id])
  appointmentId    String?

  data            Json
  status          SubmissionStatus @default(DRAFT)
  riskLevel        RiskLevel        @default(NONE)
  riskFlags        String[]

  requiresEscalation Boolean       @default(false)
  escalationReason   String?
  escalatedAt        DateTime?
  escalatedToId      String?

  signatureData   String?
  signedAt        DateTime?
  signedByName    String?
  signedByIp      String?

  practitionerId  String?
  practitioner    User?            @relation(fields: [practitionerId], references: [id])

  draftSavedAt    DateTime?
  resumeToken     String?          @unique

  isLocked        Boolean          @default(false)
  lockedAt        DateTime?
  lockedReason    String?

  pdfPath         String?
  pdfGeneratedAt  DateTime?

  googleDriveFileId  String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  submittedAt     DateTime?

  auditLogs        AuditLog[]
  amendments       Amendment[]

  @@index([brand, siteId])
  @@index([formType])
  @@index([clientId])
  @@index([appointmentId])
  @@index([status])
  @@index([riskLevel])
  @@index([createdAt])
}

// ============================================
// GOVERNANCE
// ============================================

model GovernanceLog {
  id            String             @id @default(cuid())
  formType      GovernanceFormType
  brand         Brand
  siteId        String
  site          Site               @relation(fields: [siteId], references: [id])

  completedById String
  completedBy   User               @relation(fields: [completedById], references: [id])

  data          Json               
  notes         String?
  signatureData String?            

  isCompliant   Boolean            @default(true)
  issues        String[]           
  followUpRequired Boolean         @default(false)
  followUpDate  DateTime?
  followUpNotes String?

  completedAt   DateTime           @default(now())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([formType])
  @@index([brand, siteId])
  @@index([completedAt])
  @@index([isCompliant])
}

model StaffTraining {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  trainingType    String   
  trainingDate    DateTime
  expiryDate      DateTime?
  certReference    String?
  signatureData    String?  
  assessorName    String?
  assessorSignature String?
  notes           String?
  isPassed        Boolean  @default(true)

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([trainingType])
  @@index([expiryDate])
}

// ============================================
// COMPLIANCE WATCHDOG
// ============================================

model ComplianceAlert {
  id          String   @id @default(cuid())
  source      String   
  title       String
  summary     String
  url         String?
  relevance   String?  
  severity    String   @default("INFO") 
  isRead      Boolean  @default(false)
  isDismissed Boolean  @default(false)
  scannedAt   DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([source])
  @@index([severity])
  @@index([isRead])
  @@index([scannedAt])
}

// ============================================
// KNOWLEDGE BASE
// ============================================

model KnowledgeBaseEntry {
  id            String   @id @default(cuid())
  category      String   
  brand         Brand?
  title         String
  content       String   
  version       String   @default("1.0")
  sheetId       String?  
  sheetRange    String?  
  lastSyncedAt DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([brand])
  @@index([isActive])
}

// ============================================
// AMENDMENTS
// ============================================

model Amendment {
  id                String         @id @default(cuid())
  submissionId      String
  submission        FormSubmission @relation(fields: [submissionId], references: [id])

  reason            String
  changedFields     Json
  newData           Json

  signatureData      String?
  signedAt          DateTime?
  signedByName      String?

  amendedById        String
  amendedBy          User           @relation(fields: [amendedById], references: [id])

  createdAt          DateTime       @default(now())

  @@index([submissionId])
}

// ============================================
// AUDIT TRAIL
// ============================================

model AuditLog {
  id            String          @id @default(cuid())
  submissionId  String?
  submission    FormSubmission? @relation(fields: [submissionId], references: [id])

  treatmentJourneyId String?
  treatmentJourney   TreatmentJourney? @relation(fields: [treatmentJourneyId], references: [id])

  action        String
  userId        String?
  user          User?           @relation(fields: [userId], references: [id])

  previousData  Json?
  newData       Json?
  changedFields String[]

  ipAddress     String?
  userAgent     String?

  createdAt     DateTime        @default(now())

  @@index([submissionId])
  @@index([treatmentJourneyId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// FILE STORAGE
// ============================================

model FileUpload {
  id            String   @id @default(cuid())
  submissionId  String?
  fieldName     String

  originalName  String
  storagePath   String
  mimeType      String
  sizeBytes     Int

  googleDriveFileId String?

  uploadedById  String?
  uploadedAt    DateTime @default(now())

  @@index([submissionId])
}

// ============================================
// DATA RETENTION
// ============================================

model DataRetentionPolicy {
  id              String   @id @default(cuid())
  formType        String   @unique
  retentionDays   Int
  description     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SAR (Subject Access Requests)
// ============================================

model SubjectAccessRequest {
  id              String   @id @default(cuid())
  requestorEmail  String
  requestorPhone  String?
  requestorName   String

  status          String   @default("PENDING")
  processedAt     DateTime?
  processedById   String?

  exportPath      String?
  downloadToken   String?  @unique
  downloadExpires DateTime?
  downloadCount   Int      @default(0)

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([requestorEmail])
  @@index([status])
}